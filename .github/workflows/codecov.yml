name: Code Coverage

on:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, reopened, synchronize ]

jobs:
    codecov:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3
        - name  : Install poetry
          run: pipx install poetry
        - uses: actions/setup-python@v4
          with:
            python-version: "3.10"
            cache: "poetry"
        - name: Dependencies
          run: poetry install
        - name: Run pytest
          id: pytest
          run: poetry run pytest --cov-report=xml:coverage/reports/coverage.xml --cov=charbot tests/ --cov-report=term
        - name: Upload coverage report
          uses: codecov/codecov-action@v2
          with:
            directory: ./coverage/reports/
            env_vars: OS,PYTHON
            fail_ci_if_error: true
            flags: unittests
            name: codecov-umbrella
            path_to_write_report: ./coverage/codecov_report.txt
            verbose: true
